{% extends "base.html" %}
{% block content %}
<h2>テナント管理者ポータル</h2>
<p class="small" style="color:#666">
  テナント単位の概要を確認できます。店舗や店舗管理者の詳細運用は各店舗の管理者画面で行います。
</p>

{% set _role = session.get('role') %}
{% set is_sysadmin = (_role == 'sysadmin') %}

<!-- テナント情報 -->
<div class="card" style="margin-bottom:1rem;">
  <h3>テナント情報</h3>
  {% if tenant %}
    <ul>
      <li>ID: <strong>{{ tenant.id }}</strong></li>
      <li>名称: <strong>{{ tenant.名称 }}</strong></li>
      <li>slug: <code>{{ tenant.slug }}</code></li>
    </ul>

    <!-- ボタン群 -->
    <div class="actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      {% if is_sysadmin %}
        <!-- sysadmin 用: 既存のシステム側操作 -->
        <a class="btn" href="{{ url_for('system_admin.tenant_edit', tenant_id=tenant.id) }}">編集（Sys）</a>

        <form method="post" action="{{ url_for('system_admin.tenant_delete', tenant_id=tenant.id) }}" style="display:inline">
          {% if get_csrf %}<input type="hidden" name="csrf_token" value="{{ get_csrf() }}">{% endif %}
          <button class="btn sub" type="submit" onclick="return confirm('削除しますか？配下データは残ります。');">削除（Sys）</button>
        </form>

        <form method="post" action="{{ url_for('system_admin.tenant_delete', tenant_id=tenant.id) }}" style="display:inline">
          {% if get_csrf %}<input type="hidden" name="csrf_token" value="{{ get_csrf() }}">{% endif %}
          <button class="btn sub" type="submit" onclick="return confirm('⚠ テナント配下を全削除します。実行しますか？');">パージ（Sys）</button>
        </form>
      {% else %}
        <!-- tenant_admin 用: 自分のテナントを編集/削除 -->
        <a class="btn" href="{{ url_for('tenant_admin.me_edit') }}">編集</a>
        <form method="post" action="{{ url_for('tenant_admin.dashboard') }}" style="display:inline">
          {% if get_csrf %}<input type="hidden" name="csrf_token" value="{{ get_csrf() }}">{% endif %}
          <button class="btn sub" type="submit" onclick="return confirm('このテナントを削除します。配下データは残ります。よろしいですか？');">削除</button>
        </form>
      {% endif %}
    </div>
  {% else %}
    <p>テナント情報を取得できませんでした。</p>
  {% endif %}
</div>

<!-- あなたのアカウント -->
<div class="card" style="margin-bottom:1rem;">
  <h3>あなたのアカウント</h3>
  {% if admin %}
    <ul>
      <li>ログインID: <code>{{ admin.login_id }}</code></li>
      <li>氏名: {{ admin.name }}</li>
      <li>状態: {{ "有効" if admin.active else "無効" }}</li>
      <li>最終ログイン: {{ admin.last_login or "-" }}</li>
    </ul>

    <div class="actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      {% if is_sysadmin %}
        <!-- sysadmin がテナント管理者を操作する -->
        <form method="post" action="{{ url_for('tenant_admin.dashboard') }}" style="display:inline">
          {% if get_csrf %}<input type="hidden" name="csrf_token" value="{{ get_csrf() }}">{% endif %}
          <input type="hidden" name="op" value="toggle">
          <input type="hidden" name="id" value="{{ admin.id }}">
          <button class="btn sub" type="submit">有効/無効</button>
        </form>

        <form method="post" action="{{ url_for('tenant_admin.dashboard') }}" style="display:inline">
          {% if get_csrf %}<input type="hidden" name="csrf_token" value="{{ get_csrf() }}">{% endif %}
          <input type="hidden" name="op" value="resetpw">
          <input type="hidden" name="id" value="{{ admin.id }}">
          <input name="password" placeholder="新PW" required style="width:160px">
          <button class="btn sub" type="submit">PW更新</button>
        </form>

        <form method="post" action="{{ url_for('tenant_admin.dashboard') }}" style="display:inline">
          {% if get_csrf %}<input type="hidden" name="csrf_token" value="{{ get_csrf() }}">{% endif %}
          <input type="hidden" name="op" value="delete">
          <input type="hidden" name="id" value="{{ admin.id }}">
          <button class="btn sub" type="submit">削除</button>
        </form>
      {% else %}
        <!-- tenant_admin: 自分のパスワード変更 -->
        <form method="post" action="{{ url_for('tenant_admin.dashboard') }}" style="display:inline">
          {% if get_csrf %}<input type="hidden" name="csrf_token" value="{{ get_csrf() }}">{% endif %}
          <input type="password" name="password" placeholder="新PW" required style="width:160px">
          <button class="btn sub" type="submit">自分のPWを更新</button>
        </form>
      {% endif %}
    </div>
  {% else %}
    <p>アカウント情報を取得できませんでした。</p>
  {% endif %}
</div>

<!-- 配下の店舗 + 管理者 -->
<!-- 店舗管理機能は現在利用できません -->

<div class="actions" style="display:flex; gap:8px; flex-wrap:wrap;">
  <a class="btn" href="{{ url_for('tenant_admin.dashboard') }}">フロア</a>
  <a class="btn sub" href="{{ url_for('tenant_admin.dashboard') }}">KDS</a>
  <a class="btn sub" href="{{ url_for('auth.logout') }}">ログアウト</a>
</div>
{% endblock %}
